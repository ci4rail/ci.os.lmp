# ===================================================
# mounts
# ===================================================

# Where the yocto-build happens
mount=build-dir-cpu01:
  bind: moducop-cpu01
  path: /work

# The location of kasfile.yaml (kas expects it in /repo)
mount=repo-dir-cpu01:
  bind: moducop-cpu01
  path: /repo
  read-only: true

# Yocto downloads DL_DIR
mount=download-dir-cpu01:
  bind: "{env.YOCTO_DOWNLOAD_DIR:downloads}"
  path: /downloads

# Yocto shared state cache SSTATE_DIR
mount=sstate-dir-cpu01:
  bind: "{env.YOCTO_SSTATE_CACHE_DIR:}moducop-cpu01/sstate-cache"
  path: /sstate-cache

# Yocto images (DEPLOY_DIR)
mount=install-dir-cpu01:
  bind: moducop-cpu01/install
  path: /install

# ===================================================
# envs
# ===================================================

env=moducop-cpu01-envs:
    files: [moducop-cpu01/config/mender.env]

# ===================================================
# jobs
# ===================================================

# Get layer revisions
job=moducop-cpu01-layer-revparse:
  use: image-kas
  entrypoint: /git/layer-revparse.sh /git/moducop-cpu01/src /git/moducop-cpu01/layer-revs
  mounts:
    - mount-buildingblock-gitversion-source-dir
  sources: moducop-cpu01/src
  artifact: /git/moducop-cpu01/layer-revs
  user: "{user.uid}:{user.gid}"
  annotations:
    description: "get layer revisions"
    tags:
      - cpu01

# Generate dynamic kasfile-image-naming.yaml for bringup image
job=moducop-cpu01-bringup-gen-image-version:
  use: image-kas
  depends:
    - moducop-cpu01-layer-revparse
  entrypoint: /git/gen-image-version.sh
    /git
    /git/moducop-cpu01/layer-revs
    cpu01-bringup
    /git/moducop-cpu01/generated-bringup-kasfile-image-naming.yaml
  mounts:
    - mount-buildingblock-gitversion-source-dir
  sources: moducop-cpu01/layer-revs
  artifact: /git/moducop-cpu01/generated-kasfile-image-naming.yaml
  user: "{user.uid}:{user.gid}"
  env:
    - "USER={user.name}"
  annotations:
    description: "Generate cpu01-bringup image version"
    tags:
      - cpu01


# Interactive yocto shell
# Warning: Image/Mender artifact names will be defaults!
job=moducop-cpu01-yocto-shell:
  use: image-kas
  depends:
    - moducop-cpu01-envs
  command: "shell /repo/kasfile.yaml:kasfile-image-naming.yaml"
  mounts:
    - build-dir-cpu01
    - repo-dir-cpu01
    - download-dir-cpu01
    - sstate-dir-cpu01
    - install-dir-cpu01
  working-dir: /work
  interactive: true
  env:
    - USER_ID={user.uid}
    - GROUP_ID={user.gid}
    - TERM=xterm-256color
    - SHELL=/bin/bash
    - MENDER_SERVER_URL={env.MENDER_SERVER_URL}
    - MENDER_TENANT_TOKEN={env.MENDER_TENANT_TOKEN}
    - IMAGE_NAME_SUFFIX={env.IMAGE_NAME_SUFFIX}
  annotations:
    description: "interactive yocto shell"
    tags:
      - cpu01

# Build bringup-image
job=moducop-cpu01-build-bringup-image:
  use: image-kas
  depends:
    - moducop-cpu01-envs
    - moducop-cpu01-bringup-gen-image-version
  sources:
    - moducop-cpu01/kasfile.yaml
  artifact:
    - moducop-cpu01/install/images/
  command: "build /repo/kasfile.yaml:generated-bringup-kasfile-image-naming.yaml"
  mounts:
    - build-dir-cpu01
    - repo-dir-cpu01
    - download-dir-cpu01
    - sstate-dir-cpu01
    - install-dir-cpu01
  working-dir: /work
  interactive: true
  env:
    - USER_ID={user.uid}
    - GROUP_ID={user.gid}
    - TERM=xterm-256color
    - SHELL=/bin/bash
    - MENDER_SERVER_URL={env.MENDER_SERVER_URL}
    - MENDER_TENANT_TOKEN={env.MENDER_TENANT_TOKEN}
    - IMAGE_NAME_SUFFIX={env.IMAGE_NAME_SUFFIX}
  annotations:
    description: "Build ci4rail-bringup-image"
    tags:
      - cpu01

# Clean 
job=moducop-cpu01-clean:
  use: image-kas
  entrypoint: rm -rf /downloads/ /sstate-cache/ /install/ /build/
  mounts:
    - build-dir-cpu01
    - repo-dir-cpu01
    - download-dir-cpu01
    - sstate-dir-cpu01
    - install-dir-cpu01
  working-dir: /work
  interactive: true
  env:
    - USER_ID={user.uid}
    - GROUP_ID={user.gid}
    - TERM=xterm-256color
    - SHELL=/bin/bash
  annotations:
    description: "Cleanup"
    tags:
      - cpu01
