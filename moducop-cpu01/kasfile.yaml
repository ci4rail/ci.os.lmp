#
# This kasfile requires a second kasfile to be included from 
# the kas command line 
# e.g. "build kasfile.yaml:kasfile-image-naming.yaml"
#
# The intention is that the ci pipeline uses a static file
# kasfile-image-naming.yaml, while local dobi builds
# use a dynamically generated .yaml file
header:
  version: 9
  includes:
    - kasfile-image-naming.yaml

# The machine as it is written into the `local.conf` of bitbake.
machine: moducop-cpu01
# The distro name as it is written into the `local.conf` of bitbake.
distro: tdx-xwayland
# The target that is built by bitbake
target: ci4rail-bringup-image

repos:
  # from https://git.toradex.com/cgit/toradex-manifest.git/tree/base/pinned.xml?h=5.1.0
  #
  src/bitbake:
    url: "https://github.com/openembedded/bitbake.git"
    refspec: 89fc9450abefd682266efcbfa031d1ef115ff1a7
    layers:
      # bitbake is no layer. Exclude it from bblayers.conf
      bitbake: "no"
  
  src/openembedded-core:
    url: "https://github.com/openembedded/openembedded-core.git"
    refspec: b885888df67eb5cdb3b82f4f0a07369a449e223b
    layers:
      meta:

  src/meta-openembedded:
    url: "https://github.com/openembedded/meta-openembedded.git"
    refspec: f2d02cb71eaff8eb285a1997b30be52486c160ae
    layers:
      meta-oe:
      meta-networking:
      meta-filesystems:
      meta-python:
      meta-xfce:
      meta-gnome:
      meta-multimedia:
      meta-initramfs:

  src/meta-yocto:
    url: "https://git.yoctoproject.org/git/meta-yocto.git"
    refspec: c1c79c1a122b053fb3ce0187b3cc89df1bb3bdd6
    layers:
      meta-poky:

  # from tdx: https://git.toradex.com/cgit/toradex-manifest.git/tree/bsp/pinned-nxp.xml?h=5.1.0
  src/meta-freescale-3rdparty.git:
    url: "https://github.com/Freescale/meta-freescale-3rdparty.git"
    refspec: 05b1746a4adc240b690fe965ac5b8a043d9b9d03

  src/meta-freescale-distro:
    url: "https://github.com/Freescale/meta-freescale-distro.git"
    refspec: 5d882cdf079b3bde0bd9869ce3ca3db411acbf3b
  
  src/meta-freescale:
    url: "https://github.com/Freescale/meta-freescale.git"
    refspec: 46f54fdc5ad854a22bf759aac7fd65db1d1bb574

  # from tdx: https://git.toradex.com/cgit/toradex-manifest.git/tree/bsp/pinned-tdx.xml?h=dunfell-5.x.y
  src/meta-toradex-bsp-common:
    url: "https://git.toradex.com/meta-toradex-bsp-common.git"
    refspec: cdbfe017be9096adbbfb4d3bbea0421e44f54cf3

  src/meta-toradex-nxp:
    url: "https://git.toradex.com/meta-toradex-nxp.git"
    refspec: 8e762e3c8ec5c84f76254f442f37c70dfb7e1b68

  src/meta-toradex-tegra:
    url: "https://git.toradex.com/meta-toradex-tegra.git"
    refspec: b214067b27204f471cf405a1e3997d3da233a8f9

  # from tdx: https://git.toradex.com/cgit/toradex-manifest.git/tree/tdxref/default.xml?h=5.1.0
  src/meta-qt5:
    url: "https://github.com/meta-qt5/meta-qt5.git"
    refspec: 0d8eb956015acdea7e77cd6672d08dce18061510

  src/meta-toradex-demos:
    url: "https://git.toradex.com/meta-toradex-demos.git"
    refspec: 38705bdc1ff671597680c5a9c9d1a76822bb5620

  src/meta-toradex-distro:
    url: "https://git.toradex.com/meta-toradex-distro.git"
    refspec: 48913ab629a231913e3e147e93e57f7cf6019ac6

  # mender
  src/meta-mender:
    url: "https://github.com/mendersoftware/meta-mender"
    refspec: f5864bfb32906b87cc24d5b84e74805994f0ef3e
    layers:
      meta-mender-core:
      meta-mender-demo:

  src/meta-mender-community:
    url: "https://github.com/mendersoftware/meta-mender-community"
    refspec: 2120d69c3d63405da5dcba2cefc678944b85a582
    layers:
      meta-mender-toradex-nxp:

  # docker
  src/meta-virtualization:
    url: git://git.yoctoproject.org/meta-virtualization
    refspec: ff997b6b3ba800978546098ab3cdaa113b6695e1

  # iotedge and dependencies (rust)
  # fixed revision 6840cf2a from branch `dunfell`
  src/meta-iotedge:
    url: https://github.com/Azure/meta-iotedge.git
    refspec: 6840cf2afb51b4f2c535a05d5635736652f664f7
    
  src/meta-rust:
  # fixed revision e4d25b98 from branch `master`
    url: git://github.com/meta-rust/meta-rust.git
    refspec: e4d25b98083bcecb94df6ee189a165d63ede7f3d
    
  # ci4rail
  src/meta-ci.os:
    url: https://github.com/ci4rail/meta-ci.os.git
    refspec: feature/moducop

bblayers_conf_header:
  src/meta-custom: |
    BBPATH = "${TOPDIR}"
    BBFILES ?= ""


local_conf_header:
  src/meta-custom: |
    DL_DIR ?= "/downloads"
    SSTATE_DIR ?= "/sstate-cache"
    DEPLOY_DIR = "/install"
    PACKAGE_CLASSES ?= "package_ipk"
    EXTRA_IMAGE_FEATURES ?= "debug-tweaks package-management"
    USER_CLASSES ?= "buildstats image-mklibs image-prelink"
    PATCHRESOLVE = "noop"
    BB_DISKMON_DIRS ??= "\
        STOPTASKS,${TMPDIR},1G,100K \
        STOPTASKS,${DL_DIR},1G,100K \
        STOPTASKS,${SSTATE_DIR},1G,100K \
        STOPTASKS,/tmp,100M,100K \
        ABORT,${TMPDIR},100M,1K \
        ABORT,${DL_DIR},100M,1K \
        ABORT,${SSTATE_DIR},100M,1K \
        ABORT,/tmp,10M,1K"
    PACKAGECONFIG_append_pn-qemu-system-native = " sdl"
    PACKAGECONFIG_append_pn-nativesdk-qemu = " sdl"
    CONF_VERSION = "1"
    INHERIT += "rm_work"
    INHERIT += "toradex-mirrors"
    DISTRO = "tdx-xwayland"
    include conf/machine/include/${MACHINE}.inc
    INHERIT += "mender-full"
    DISTRO_FEATURES_append = " systemd virtualization"
    VIRTUAL-RUNTIME_init_manager = "systemd"
    DISTRO_FEATURES_BACKFILL_CONSIDERED = "sysvinit"
    VIRTUAL-RUNTIME_initscripts = ""
    MENDER_FEATURES_ENABLE_append = " mender-uboot mender-image-sd"
    MENDER_FEATURES_DISABLE_append = " mender-grub mender-image-uefi"
    IMAGE_CLASSES += "image_type_mender_tezi"
    IMAGE_FSTYPES_append = " mender_tezi"
    IMAGE_FSTYPES_remove = " teziimg"
    KERNEL_IMAGETYPE_aarch64_mender-grub = "Image"
    IMAGE_BOOT_FILES = ""
    IMAGE_BOOT_FILES_remove_mender-grub = "boot.scr-verdin-imx8mm;boot.scr"
    OFFSET_SPL_PAYLOAD_verdin-imx8mm = ""
    ACCEPT_FSL_EULA = "1"
    IMAGE_FEATURES_append = " read-only-rootfs"
    IMAGE_INSTALL_append = " nano pciutils minicom fio nano docker-ce ca-certificates \
        iotedge-daemon iotedge-cli overlay-directories persistent-journald kyt-dlm-devinfo-static device-state-service"
    MENDER_UPDATE_POLL_INTERVAL_SECONDS = "20"
    MENDER_INVENTORY_POLL_INTERVAL_SECONDS = "20"
    MENDER_STORAGE_TOTAL_SIZE_MB = "4096"
