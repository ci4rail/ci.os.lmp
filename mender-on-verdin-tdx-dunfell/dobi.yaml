# ===================================================
# mounts
# ===================================================

# Where the yocto-build happens
mount=yocto-build-dir:
  bind: yocto-workdir
  path: /work

# The location of the KASFILE.yaml
mount=repo-dir:
  bind: .
  path: /repo
  read-only: true


# ===================================================
# images
# ===================================================
image=image-kas:
  image: ghcr.io/siemens/kas/kas
  tags: ['2.2']
  pull: always
  annotations:
    description: "kas image"

# ===================================================
# jobs
# ===================================================

# Interactive yocto shell
job=yocto-shell:
  use: image-kas
  command: shell /repo/KASFILE.yaml
  mounts:
    - yocto-build-dir
    - repo-dir
  working-dir: /work
  interactive: true
  env:
    - USER_ID={user.uid}
    - GROUP_ID={user.gid}
    - TERM=xterm-256color
    - SHELL=/bin/bash

  annotations:
    description: "interactive shell for yocto"

# Build tdx-reference-minimal-image
job=build-minimal-image:
  use: image-kas
  sources: [KASFILE.yaml]
  command: build --target tdx-reference-minimal-image /repo/KASFILE.yaml
  mounts:
    - yocto-build-dir
    - repo-dir
  working-dir: /work
  interactive: true
  env:
    - USER_ID={user.uid}
    - GROUP_ID={user.gid}
    - TERM=xterm-256color
    - SHELL=/bin/bash

  annotations:
    description: "Build tdx-reference-minimal-image"